# File Naming Trait Guide

## Overview
The `FileNamingTrait` provides a standardized way to rename uploaded files across the application with the format:
```
{application_id}_{column_name}_{uniqid}.{extension}
```

Example: `123_khs_all_65a1b2c3d4e5f.pdf`

## Installation

### 1. Add Trait to Your Model

```php
use App\Traits\FileNamingTrait;

class YourModel extends Model implements HasMedia
{
    use InteractsWithMedia, FileNamingTrait;
    
    // Your existing registerMediaConversions method remains unchanged
    public function registerMediaConversions(Media $media = null): void
    {
        $this->addMediaConversion('thumb')->fit('crop', 50, 50);
        $this->addMediaConversion('preview')->fit('crop', 120, 120);
    }
    
    // Your model code...
}
```

### 2. Requirements

- Model must implement `HasMedia` interface
- Model must use `InteractsWithMedia` trait from Spatie MediaLibrary
- Model should have an `application_id` field (or the trait will use 'no_app' as fallback)
- The trait does not interfere with existing `registerMediaConversions()` or `registerMediaCollections()` methods

## Usage Examples

### Single File Upload

```php
// In your controller
$model->addMediaWithCustomName(
    storage_path('tmp/uploads/' . $filename), 
    'collection_name'
);
```

### Multiple Files Upload

```php
// Upload multiple files at once
$files = [
    storage_path('tmp/uploads/file1.pdf'),
    storage_path('tmp/uploads/file2.pdf'),
    storage_path('tmp/uploads/file3.pdf'),
];

$model->addMultipleMediaWithCustomName($files, 'documents');
```

### In Controller Store Method

```php
public function store(Request $request)
{
    $model = YourModel::create($request->all());
    
    // Single file
    if ($request->input('single_file', false)) {
        $model->addMediaWithCustomName(
            storage_path('tmp/uploads/' . basename($request->input('single_file'))), 
            'single_file'
        );
    }
    
    // Multiple files
    foreach ($request->input('multiple_files', []) as $file) {
        $model->addMediaWithCustomName(
            storage_path('tmp/uploads/' . basename($file)), 
            'multiple_files'
        );
    }
    
    return redirect()->route('your.route');
}
```

### In Controller Update Method

```php
public function update(Request $request, YourModel $model)
{
    $model->update($request->all());
    
    // Handle file replacement
    if ($request->input('document', false)) {
        if ($model->document) {
            $model->document->delete();
        }
        $model->addMediaWithCustomName(
            storage_path('tmp/uploads/' . basename($request->input('document'))), 
            'document'
        );
    }
    
    return redirect()->route('your.route');
}
```

## File Naming Pattern Breakdown

Given:
- `application_id` = 123
- `collection_name` = 'khs_all'
- File = 'transcript.pdf'

Result: `123_khs_all_65a1b2c3d4e5f.pdf`

Components:
1. **123** - Application ID from the model
2. **khs_all** - Collection name (sanitized)
3. **65a1b2c3d4e5f** - Unique ID generated by `uniqid()`
4. **.pdf** - Original file extension

## Methods Available

### `addMediaWithCustomName($file, $collectionName)`
Upload a single file with custom naming.

**Parameters:**
- `$file` (string): Full path to the file
- `$collectionName` (string): Media collection name

**Returns:** Media object

---

### `addMultipleMediaWithCustomName($files, $collectionName)`
Upload multiple files with custom naming.

**Parameters:**
- `$files` (array): Array of file paths
- `$collectionName` (string): Media collection name

**Returns:** void

---

### `generateFileName($collectionName)`
Generate the base filename without extension.

**Parameters:**
- `$collectionName` (string): Media collection name

**Returns:** string (e.g., "123_khs_all_65a1b2c3d4e5f")

---

### `generateCustomFileName($file, $collectionName)`
Generate complete filename with extension.

**Parameters:**
- `$file` (string): File path
- `$collectionName` (string): Media collection name

**Returns:** string (e.g., "123_khs_all_65a1b2c3d4e5f.pdf")

## Integration with Existing Models

### Example: SkripsiRegistration Model

```php
<?php

namespace App\Models;

use App\Traits\FileNamingTrait;
use Spatie\MediaLibrary\HasMedia;
use Spatie\MediaLibrary\InteractsWithMedia;

class SkripsiRegistration extends Model implements HasMedia
{
    use InteractsWithMedia, FileNamingTrait;

    protected $fillable = [
        'application_id',
        'title',
        // other fields...
    ];
    
    public function application()
    {
        return $this->belongsTo(Application::class);
    }
}
```

### Controller Implementation

```php
public function store(Request $request)
{
    // Create Application first
    $application = Application::create([
        'mahasiswa_id' => auth()->user()->mahasiswa_id,
        'type' => 'skripsi',
        'stage' => 'registration',
        'status' => 'submitted',
    ]);
    
    // Create model with application_id
    $registration = SkripsiRegistration::create([
        'application_id' => $application->id,
        'title' => $request->title,
    ]);
    
    // Upload files with custom naming
    foreach ($request->input('khs_all', []) as $file) {
        $registration->addMediaWithCustomName(
            storage_path('tmp/uploads/' . basename($file)), 
            'khs_all'
        );
    }
    
    if ($request->input('krs_latest', false)) {
        $registration->addMediaWithCustomName(
            storage_path('tmp/uploads/' . basename($request->input('krs_latest'))), 
            'krs_latest'
        );
    }
    
    return redirect()->route('registrations.index');
}
```

## Benefits

1. **Standardized Naming**: All files follow the same naming convention
2. **Traceability**: Easy to identify which application a file belongs to
3. **Organization**: Files are organized by collection/column name
4. **Uniqueness**: `uniqid()` ensures no naming conflicts
5. **Reusability**: Use the same trait across multiple models
6. **Maintainability**: Centralized file naming logic

## Notes

- The trait automatically sanitizes collection names (replaces spaces with underscores)
- If `application_id` is not set, it will use 'no_app' as a fallback
- Original file extensions are preserved
- Works seamlessly with Spatie MediaLibrary features (conversions, collections, etc.)

## Troubleshooting

### Issue: "application_id not found"
**Solution**: Ensure your model has an `application_id` field or relationship loaded before uploading files.

### Issue: Files not uploading
**Solution**: Check that:
- Spatie MediaLibrary is properly installed
- Model implements `HasMedia` interface
- Model uses `InteractsWithMedia` trait
- File path is correct and file exists

### Issue: Wrong file names
**Solution**: Verify that:
- `application_id` is set correctly
- Collection name is passed correctly to the method
- Trait is imported in the model

